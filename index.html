<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VL53L0X Live Plot (for example sketch)</title>
<link rel="icon" href="data:,">
<style>
  :root { --gap:10px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:16px; }
  h1 { margin:0 0 12px; font-size:26px; }
  .toolbar { display:flex; flex-wrap:wrap; align-items:center; gap:var(--gap); margin-bottom:var(--gap); }
  .toolbar button { padding:6px 12px; }
  #status { font-weight:700; }
  #chartWrap { width:100%; height:520px; }
  canvas { width:100% !important; height:100% !important; }
  #env { font-size:12px; color:#0369a1; margin:4px 0 10px; }
  .panel { display:grid; grid-template-columns: 1fr 300px; gap:12px; align-items:start; }
  .box { border:1px solid #e5e7eb; border-radius:8px; padding:10px; }
  #log { height:150px; overflow:auto; background:#fafafa; font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre; }
  .kv { font-size:13px; line-height:1.4; }
  .kv span { display:inline-block; min-width:120px; color:#334155; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
  <h1>VL53L0X Live Plot</h1>

  <div class="toolbar">
    <button id="btnConnect">Connect</button>
    <button id="btnDisconnect">Disconnect</button>
    <button id="btnStart">Start</button>
    <button id="btnStop">Stop</button>
    <button id="btnReset">Reset</button>
    <button id="btnCsv">CSV</button>
    <span id="status">DISCONNECTED</span>
  </div>

  <div id="env"></div>

  <div class="panel">
    <div id="chartWrap" class="box"><canvas id="chart"></canvas></div>
    <div class="box">
      <div class="kv"><span>Last value:</span><b id="lastVal">—</b></div>
      <div class="kv"><span>Receive rate:</span><b id="rxHz">0</b> Hz</div>
      <div class="kv"><span>Records:</span><b id="recCount">0</b></div>
      <div class="kv"><span>Notes:</span> 9600 bps / 1行=mm / 非数値や TIMEOUT は無視</div>
      <div id="log"></div>
    </div>
  </div>

<script>
(() => {
  // --- Environment check ---
  const envEl = document.getElementById('env');
  const msgs = [];
  if (!('serial' in navigator)) msgs.push('このブラウザはWeb Serial未対応（Chrome/Edge デスクトップ）。');
  if (!window.isSecureContext)  msgs.push('HTTPS または localhost で開いてください（file:// は不可）。');
  if (msgs.length) envEl.textContent = '環境チェック: ' + msgs.join(' / ');

  // --- Chart.js setup ---
  const ctx = document.getElementById('chart');
  const data = { labels: [], datasets: [{ label:'Distance [mm]', data: [], tension:0, pointRadius:0, parsing:false }]};
  const chart = new Chart(ctx, {
    type: 'line',
    data,
    options: {
      animation: false,
      responsive: true,
      normalized: true,
      scales: {
        x: { type:'linear', title:{display:true, text:'Time [s]'}, min:0, max:10 },
        y: { beginAtZero:true, title:{display:true, text:'Distance [mm]'}, suggestedMax:1000 }
      },
      plugins: { legend:{ display:false } }
    }
  });

  let xWindow = 10; // seconds
  function pushPoint(tSec, mm) {
    if (!Number.isFinite(mm) || mm <= 0 || mm >= 4000) return;
    data.datasets[0].data.push({ x:tSec, y:mm });
    if (mm > (chart.options.scales.y.suggestedMax ?? 1000)) {
      chart.options.scales.y.suggestedMax = Math.ceil(mm / 200) * 200;
    }
    if (tSec > xWindow) {
      xWindow = Math.ceil(tSec / 10) * 10;
      chart.options.scales.x.max = xWindow;
    }
    requestUpdate();
  }

  // Throttled chart updates
  let rafId = null, needs = false;
  function requestUpdate() {
    if (rafId) { needs = true; return; }
    rafId = requestAnimationFrame(() => {
      chart.update('none');
      rafId = null;
      if (needs) { needs = false; requestUpdate(); }
    });
  }

  // --- CSV buffer ---
  const records = []; // {t, mm}
  function downloadCsv() {
    if (!records.length) return;
    const header = 't_ms,mm,cm\n';
    const body = records.map(r => `${r.t},${r.mm},${(r.mm/10).toFixed(1)}`).join('\n')+'\n';
    const blob = new Blob([header+body], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'vl53l0x_log.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // --- UI + debug ---
  const $ = id => document.getElementById(id);
  const statusEl = $('status'), lastValEl = $('lastVal'), rxHzEl = $('rxHz'), recCountEl = $('recCount'), logEl = $('log');
  function log(s){ logEl.textContent += s + '\n'; logEl.scrollTop = logEl.scrollHeight; }

  // --- Serial plumbing ---
  let port=null, reader=null, reading=false;
  let streaming=false;     // Start/StopでON/OFF。Connect時は自動でONにする
  let t0=0;
  let rxTimes = [];        // 直近1秒の受信タイムスタンプ

  async function startReading() {
    const textDecoder = new TextDecoderStream();
    port.readable.pipeTo(textDecoder.writable).catch(()=>{});
    reader = textDecoder.readable.getReader();
    let buf = ''; reading = true;
    log('[reader] started');
    while (reading) {
      const { value, done } = await reader.read().catch(e => { log('[reader] error: '+e); return {value:null, done:true}; });
      if (done) break;
      if (!value) continue;
      buf += value;
      let idx;
      while ((idx = buf.indexOf('\n')) >= 0) {
        const line = buf.slice(0, idx).replace(/\r$/, '').trim();
        buf = buf.slice(idx + 1);
        handleLine(line);
      }
    }
    log('[reader] stopped');
  }

  function handleLine(line) {
    if (!line) return;
    if (line.includes('TIMEOUT')) { log('[skip] TIMEOUT'); return; }

    // 行の中の最初の整数だけを拾う（例: "1234", "1234 extra", "value=1234" などOK）
    const m = line.match(/-?\d{1,6}/);
    if (!m) { log('[skip] non-numeric: ' + line); return; }
    const mm = parseInt(m[0], 10);
    lastValEl.textContent = String(mm);

    // 受信レート測定（直近1秒）
    const now = performance.now();
    rxTimes.push(now);
    while (rxTimes.length && now - rxTimes[0] > 1000) rxTimes.shift();
    rxHzEl.textContent = rxTimes.length.toString();

    if (!streaming) return;
    if (!t0) t0 = performance.now();
    const t_ms = Math.round(now - t0);
    records.push({ t: t_ms, mm });
    recCountEl.textContent = String(records.length);
    pushPoint(t_ms/1000, mm);
  }

  // --- Wire up buttons ---
  $('btnConnect').addEventListener('click', async () => {
    if (!('serial' in navigator)) { alert('Web Serial未対応です'); return; }
    try {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 }); // 例スケッチに合わせる
      statusEl.textContent = 'CONNECTED';
      log('[open] ok 9600bps');
      // 自動で受信＆表示ON
      streaming = true;
      t0 = 0;
      startReading();
    } catch (e) {
      alert('Serial接続に失敗: ' + e);
      log('[open] error: ' + e);
    }
  });

  $('btnDisconnect').addEventListener('click', async () => {
    streaming = false;
    reading = false;
    try { if (reader) await reader.cancel(); } catch {}
    try { if (reader) { reader.releaseLock(); reader = null; } } catch {}
    try { if (port) await port.close(); } catch {}
    port = null;
    statusEl.textContent = 'DISCONNECTED';
    log('[close] done');
  });

  $('btnStart').addEventListener('click', () => {
    if (!port) { alert('先にConnectしてください'); return; }
    streaming = true; t0 = 0; statusEl.textContent = 'STREAMING'; log('[stream] start');
  });
  $('btnStop').addEventListener('click', () => {
    streaming = false; statusEl.textContent = 'STOPPED'; log('[stream] stop');
  });

  $('btnReset').addEventListener('click', () => {
    streaming = false;
    data.datasets[0].data.length = 0;
    records.length = 0; recCountEl.textContent = '0';
    chart.options.scales.x.min = 0; chart.options.scales.x.max = 10; chart.options.scales.y.suggestedMax = 1000;
    xWindow = 10; chart.update('none'); t0 = 0; lastValEl.textContent = '—'; rxHzEl.textContent = '0';
    log('[reset] ui cleared');
    statusEl.textContent = 'RESET';
  });

  $('btnCsv').addEventListener('click', downloadCsv);

  // Final warning if unsupported
  if (!('serial' in navigator)) {
    alert('このブラウザはWeb Serialに対応していません。Chrome/Edgeの最新をHTTPSまたはlocalhostでお使いください。');
  }
})();
</script>
</body>
</html>
